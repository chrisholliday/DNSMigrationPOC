{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "1248289838044348630"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "centralus"
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "azureuser"
    },
    "sshPublicKey": {
      "type": "securestring"
    }
  },
  "variables": {
    "privatelinkZone": "[format('privatelink.blob.{0}', environment().suffixes.storage)]",
    "onpremDnsIp": "10.10.1.4",
    "onpremClientIp": "10.10.1.5",
    "hubDnsIp": "10.20.1.4",
    "spoke1VmIp": "10.30.1.4",
    "spoke2VmIp": "10.40.1.4"
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-onprem-dns-nic",
      "location": "[parameters('location')]",
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'dnsmig-onprem-vnet', 'dnsmig-onprem-subnet')]"
              },
              "privateIPAddress": "[variables('onpremDnsIp')]",
              "privateIPAllocationMethod": "Static"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-onprem-client-nic",
      "location": "[parameters('location')]",
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'dnsmig-onprem-vnet', 'dnsmig-onprem-subnet')]"
              },
              "privateIPAddress": "[variables('onpremClientIp')]",
              "privateIPAllocationMethod": "Static"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-hub-dns-nic",
      "location": "[parameters('location')]",
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'dnsmig-hub-vnet', 'dnsmig-hub-vm-subnet')]"
              },
              "privateIPAddress": "[variables('hubDnsIp')]",
              "privateIPAllocationMethod": "Static"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-spoke1-vm-nic",
      "location": "[parameters('location')]",
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'dnsmig-spoke1-vnet', 'dnsmig-spoke1-vm-subnet')]"
              },
              "privateIPAddress": "[variables('spoke1VmIp')]",
              "privateIPAllocationMethod": "Static"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-spoke2-vm-nic",
      "location": "[parameters('location')]",
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'dnsmig-spoke2-vnet', 'dnsmig-spoke2-vm-subnet')]"
              },
              "privateIPAddress": "[variables('spoke2VmIp')]",
              "privateIPAllocationMethod": "Static"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-onprem-dns",
      "location": "[parameters('location')]",
      "properties": {
        "hardwareProfile": {
          "vmSize": "Standard_B2s"
        },
        "osProfile": {
          "computerName": "dns-onprem",
          "adminUsername": "[parameters('adminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                  "keyData": "[parameters('sshPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "0001-com-ubuntu-server-jammy",
            "sku": "22_04-lts-gen2",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "Premium_LRS"
            }
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-onprem-dns-nic')]",
              "properties": {
                "primary": true
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-onprem-dns-nic')]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2023-09-01",
      "name": "[format('{0}/{1}', 'dnsmig-onprem-dns', 'CloudInit')]",
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "script": "[base64(format('#!/bin/bash\r\nset -e\r\n\r\n# Install dnsmasq\r\napt-get update -qq\r\napt-get install -y -qq dnsmasq\r\n\r\n# Configure dnsmasq zones (listen on port 5053 to avoid conflict with systemd-resolved)\r\ncat > /etc/dnsmasq.d/onprem.conf <<EOF\r\nport=5053\r\naddress=/onprem.pvt/{0}\r\naddress=/azure.pvt/{1}\r\naddress=/{2}/{1}\r\nserver=/onprem.pvt/127.0.0.1#5053\r\nserver=/azure.pvt/{1}#53\r\nserver=/{2}/{1}#53\r\nEOF\r\n\r\n# Update resolv.conf to query local dnsmasq then upstream\r\necho \"nameserver 127.0.0.1\" > /tmp/resolv.conf.new\r\necho \"options edns0\" >> /tmp/resolv.conf.new\r\nmv /tmp/resolv.conf.new /etc/resolv.conf\r\n\r\n# Start dnsmasq\r\nsystemctl restart dnsmasq\r\nsystemctl enable dnsmasq\r\n', variables('onpremDnsIp'), variables('hubDnsIp'), variables('privatelinkZone')))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', 'dnsmig-onprem-dns')]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-onprem-client",
      "location": "[parameters('location')]",
      "properties": {
        "hardwareProfile": {
          "vmSize": "Standard_B2s"
        },
        "osProfile": {
          "computerName": "client-onprem",
          "adminUsername": "[parameters('adminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                  "keyData": "[parameters('sshPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "0001-com-ubuntu-server-jammy",
            "sku": "22_04-lts-gen2",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "Premium_LRS"
            }
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-onprem-client-nic')]",
              "properties": {
                "primary": true
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-onprem-client-nic')]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2023-09-01",
      "name": "[format('{0}/{1}', 'dnsmig-onprem-client', 'CloudInit')]",
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "script": "[base64(format('#!/bin/bash\napt-get update\napt-get install -y dnsutils\necho \"nameserver {0}\" > /etc/resolv.conf\n', variables('onpremDnsIp')))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', 'dnsmig-onprem-client')]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-hub-dns",
      "location": "[parameters('location')]",
      "properties": {
        "hardwareProfile": {
          "vmSize": "Standard_B2s"
        },
        "osProfile": {
          "computerName": "dns-hub",
          "adminUsername": "[parameters('adminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                  "keyData": "[parameters('sshPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "0001-com-ubuntu-server-jammy",
            "sku": "22_04-lts-gen2",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "Premium_LRS"
            }
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-hub-dns-nic')]",
              "properties": {
                "primary": true
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-hub-dns-nic')]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2023-09-01",
      "name": "[format('{0}/{1}', 'dnsmig-hub-dns', 'CloudInit')]",
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "script": "[base64(format('#!/bin/bash\r\nset -e\r\n\r\n# Install dnsmasq\r\napt-get update -qq\r\napt-get install -y -qq dnsmasq\r\n\r\n# Configure dnsmasq zones (listen on port 5053 to avoid conflict with systemd-resolved)\r\ncat > /etc/dnsmasq.d/azure.conf <<EOF\r\nport=5053\r\naddress=/azure.pvt/{0}\r\naddress=/{1}/{0}\r\nserver=/azure.pvt/127.0.0.1#5053\r\nserver=/{1}/{0}#53\r\nEOF\r\n\r\n# Update resolv.conf to query local dnsmasq then upstream\r\necho \"nameserver 127.0.0.1\" > /tmp/resolv.conf.new\r\necho \"options edns0\" >> /tmp/resolv.conf.new\r\nmv /tmp/resolv.conf.new /etc/resolv.conf\r\n\r\n# Start dnsmasq\r\nsystemctl restart dnsmasq\r\nsystemctl enable dnsmasq\r\n', variables('hubDnsIp'), variables('privatelinkZone')))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', 'dnsmig-hub-dns')]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-spoke1-app",
      "location": "[parameters('location')]",
      "properties": {
        "hardwareProfile": {
          "vmSize": "Standard_B2s"
        },
        "osProfile": {
          "computerName": "app-spoke1",
          "adminUsername": "[parameters('adminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                  "keyData": "[parameters('sshPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "0001-com-ubuntu-server-jammy",
            "sku": "22_04-lts-gen2",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "Premium_LRS"
            }
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-spoke1-vm-nic')]",
              "properties": {
                "primary": true
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-spoke1-vm-nic')]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2023-09-01",
      "name": "[format('{0}/{1}', 'dnsmig-spoke1-app', 'CloudInit')]",
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "script": "[base64('#!/bin/bash\napt-get update\napt-get install -y dnsutils\n')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', 'dnsmig-spoke1-app')]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-09-01",
      "name": "dnsmig-spoke2-app",
      "location": "[parameters('location')]",
      "properties": {
        "hardwareProfile": {
          "vmSize": "Standard_B2s"
        },
        "osProfile": {
          "computerName": "app-spoke2",
          "adminUsername": "[parameters('adminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                  "keyData": "[parameters('sshPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "0001-com-ubuntu-server-jammy",
            "sku": "22_04-lts-gen2",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "Premium_LRS"
            }
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-spoke2-vm-nic')]",
              "properties": {
                "primary": true
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', 'dnsmig-spoke2-vm-nic')]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2023-09-01",
      "name": "[format('{0}/{1}', 'dnsmig-spoke2-app', 'CloudInit')]",
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "script": "[base64('#!/bin/bash\napt-get update\napt-get install -y dnsutils\n')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', 'dnsmig-spoke2-app')]"
      ]
    }
  ],
  "outputs": {
    "vmsCreated": {
      "type": "bool",
      "value": true
    }
  }
}